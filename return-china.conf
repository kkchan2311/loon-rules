# !loon
# ==========================================================
# Loon Optimized configuration when returning to China (Return-to-China)
#
# - Scenario: Overseas users (such as Malaysia) access mainland China services
# - Optimization: Automatically select the Hong Kong/South Korea node with the lowest delay as the return route
# - Author: kkchan2311
# - Update date: 2026-02-01
# ==========================================================
[General]
ip-mode=v4-only
ipv6-vif=off
dns-server=system
sni-sniffing=true
# Cloudflare和Goole DoH
doh-server=https://1.1.1.1/dns-query, https://dns.google/dns-query
disable-stun=true
dns-reject-mode=LoopbackIP
domain-reject-mode=DNS
udp-fallback-mode=REJECT
wifi-access-http-port=7222
wifi-access-socks5-port=7221
allow-wifi-access=false
interface-mode=auto
test-timeout=5
disconnect-on-policy-change=false
internet-test-url=http://www.msftconnecttest.com/connecttest.txt
proxy-test-url=http://www.gstatic.com/generate_204
resource-parser=https://raw.githubusercontent.com/sub-store-org/Sub-Store/release/sub-store-parser.loon.min.js
geoip-url=https://geodata.kelee.one/Country-Masaiki.mmdb
ipasn-url=https://geodata.kelee.one/GeoLite2-ASN-P3TERX.mmdb
skip-proxy=192.168.0.0/16, 10.0.0.0/8, 172.16.0.0/12, localhost, *.local, e.crashlynatics.com
bypass-tun=10.0.0.0/8, 100.64.0.0/10, 127.0.0.0/8, 169.254.0.0/16, 172.16.0.0/12, 192.0.0.0/24, 192.0.2.0/24, 192.88.99.0/24, 192.168.0.0/16, 198.51.100.0/24, 203.0.113.0/24, 224.0.0.0/4, 255.255.255.255/32

[Proxy]



[Remote Proxy]


[Remote Filter]
# --- 节点筛选 ---
# 使用正则表达式筛选出不同地区的节点, 方便在策略组中调用
# 香港节点: 包含 "HK", "Hong Kong", "香港", "港" 等关键字
香港节点 = subscription-name="我的机场订阅", type=name-regex, policy-regex="(?i)HK|Hong Kong|香港|港"
# 韩国节点: 包含 "KR", "Korea", "韩国", "韩" 等关键字
韩国节点 = subscription-name="我的机场订阅", type=name-regex, policy-regex="(?i)KR|Korea|韩国|韩|首尔"
# 美国节点: 包含 "US", "USA", "United States", "美国", "美" 等关键字
美国节点 = subscription-name="我的机场订阅", type=name-regex, policy-regex="(?i)US|USA|United States|美国|美|LA|NY"
# 德国节点: 包含 "DE", "Germany", "德国", "德" 等关键字
德国节点 = subscription-name="我的机场订阅", type=name-regex, policy-regex="(?i)DE|Germany|德国|德|法兰克福"

[Proxy Group]
# --- 策略组 ---
# 回国线路: 自动测试香港和韩国节点, 选择延迟最低的作为回国线路
# url-test 会定期测试节点连通性并自动选择最快的节点
回国线路 = url-test, 香港节点, 韩国节点, interval=300, timeout=5, url=http://www.baidu.com/generate_204

海外线路 = select, 美国节点, 德国节点

# 全球优选: 最终决策策略组, 用于 FINAL 规则
# 默认情况下, 所有未匹配规则的流量会通过此策略组
# 您可以在这里手动选择使用「回国线路」还是「海外线路」
全球优选 = select, 回国线路, 海外线路, DIRECT

[Rule]
# --- 本地分流规则 ---
# 规则顺序由上至下匹配, 匹配即生效

# 1. 广告屏蔽 (建议使用远程规则或插件)
# DOMAIN-KEYWORD, ad, REJECT

# 2. 中国大陆 IP 走回国线路
GEOIP, CN, 回国线路

# 3. 常见中国大陆服务域名走回国线路
DOMAIN-SUFFIX, 126.net, 回国线路
DOMAIN-SUFFIX, 163.com, 回国线路
DOMAIN-SUFFIX, bilibili.com, 回国线路
DOMAIN-SUFFIX, bilivideo.com, 回国线路
DOMAIN-SUFFIX, douyin.com, 回国线路
DOMAIN-SUFFIX, iqiyi.com, 回国线路
DOMAIN-SUFFIX, qq.com, 回国线路
DOMAIN-SUFFIX, tencent.com, 回国线路
DOMAIN-SUFFIX, weibo.com, 回国线路
DOMAIN-SUFFIX, youku.com, 回国线路
DOMAIN-SUFFIX, xiami.com, 回国线路
DOMAIN-SUFFIX, amap.com, 回国线路

# 4. 常见海外服务走海外线路
DOMAIN-SUFFIX, google.com, 海外线路
DOMAIN-SUFFIX, youtube.com, 海外线路
DOMAIN-SUFFIX, facebook.com, 海外线路
DOMAIN-SUFFIX, twitter.com, 海外线路
DOMAIN-SUFFIX, telegram.org, 海外线路
DOMAIN-SUFFIX, instagram.com, 海外线路

# 5. 局域网和特殊地址直连
IP-CIDR, 192.168.0.0/16, DIRECT
IP-CIDR, 10.0.0.0/8, DIRECT
IP-CIDR, 172.16.0.0/12, DIRECT
IP-CIDR, 127.0.0.1/32, DIRECT

# 6. 最终规则: 未匹配的流量都走「全球优选」策略
FINAL, 全球优选

[Remote Rule]
# --- 远程分流规则 ---
# 引用社区维护的规则集, 更加全面, 自动更新

# 1. China.list: 包含大量中国大陆常用域名和 App 的规则
# policy=回国线路 表示匹配到此规则的流量, 全部走「回国线路」策略组
https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Loon/China/China.list, policy=回国线路, tag=China, enabled=true

# 2. Global.list: 包含大量海外常用域名和 App 的规则
# policy=海外线路 表示匹配到此规则的流量, 全部走「海外线路」策略组
https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Loon/Global/Global.list, policy=海外线路, tag=Global, enabled=true

[MitM]
# --- MitM (Man-in-the-Middle) ---
# 用于解密 HTTPS 流量, 是实现某些高级功能 (如去广告、签到脚本) 的前提
# 启用 MitM 后, 需要在 Loon 中生成新的证书并到系统设置中信任它
# skip-server-cert-verify = true 可以跳过证书校验, 解决部分 App 的证书错误问题, 但会降低安全性, 请按需开启
skip-server-cert-verify = true
hostname = *.douyin.com, *.music.163.com, *.bilibili.com, *.iqiyi.com, *.v.qq.com

[Plugin]
# --- 插件 ---
# 插件用于实现去广告、自动签到等高级功能。
# 推荐使用 Sub-Store 来管理和转换节点订阅, 非常方便。
# 去广告插件可以在社区中寻找, 例如 Bilibili_remove_ads.plugin。
# 插件的添加和管理在 Loon 的「插件」页面进行, 无需在此处编写。
# 示例 (仅为说明, 不会生效):
# https://raw.githubusercontent.com/example/Bilibili_remove_ads.plugin, enabled=true
https://kelee.one/Tool/Loon/Lpx/Block_HTTPDNS.lpx, pin=true, enabled=true
https://kelee.one/Tool/Loon/Lpx/BlockAdvertisers.lpx, pin=true, enabled=true
https://kelee.one/Tool/Loon/Lpx/QuickSearch.lpx, enabled=true
https://kelee.one/Tool/Loon/Lpx/Prevent_DNS_Leaks.lpx, policy=DIRECT, enabled=true
https://kelee.one/Tool/Loon/Lpx/Node_detection_tool.lpx, enabled=true
https://kelee.one/Tool/Loon/Lpx/TestFlightRegionUnlock.lpx, policy=DIRECT, enabled=false
https://kelee.one/Tool/Loon/Lpx/BoxJs.lpx, policy=DIRECT, enabled=true
https://kelee.one/Tool/Loon/Lpx/Sub-Store.lpx, policy=DIRECT, enabled=true
https://kelee.one/Tool/Loon/Lpx/Script-Hub.lpx, policy=DIRECT, enabled=true
